<!DOCTYPE html>
<html lang="fr">
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>Gestion Flotte Automobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
      body { background-color: #f8f9fa; font-family: 'Segoe UI', system-ui, sans-serif; }
      .section-app { display: none; }
      .active-section { display: block; animation: fadeIn 0.4s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .navbar { box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
      .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 12px; }
      .table-hover tbody tr:hover { background-color: #f1f3f5; }
    </style>
  </head>
  <body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#"><i class="bi bi-car-front-fill me-2"></i>Flotte Auto</a>
        <div class="d-flex text-white align-items-center">
           <span id="userEmail" class="me-3 small opacity-75 d-none d-md-block">Chargement...</span>
           <button id="btnSwitchAdmin" class="btn btn-sm btn-light text-primary fw-bold d-none shadow-sm" onclick="basculerVue('garage')">
             <i class="bi bi-tools me-1"></i> Acc√®s Atelier
           </button>
           <button id="btnSwitchDriver" class="btn btn-sm btn-outline-light ms-2 d-none" onclick="basculerVue('conducteur')">
             <i class="bi bi-person me-1"></i> Vue Conducteur
           </button>
        </div>
      </div>
    </nav>

    <div class="container mt-5">

      <div id="vue-conducteur" class="section-app active-section">
        <div class="row justify-content-center">
          <div class="col-md-8 col-lg-6">
            <div class="text-center mb-4">
              <h2 class="fw-bold text-secondary">D√©clarer une intervention</h2>
              <p class="text-muted">Remplissez ce formulaire pour notifier l'atelier.</p>
            </div>

            <div class="card p-4">
              <form id="formReparation">
                
                <h6 class="text-primary mb-3">üë§ Conducteur</h6>
                <div class="mb-3">
                  <label class="form-label fw-semibold">Nom & Pr√©nom</label>
                  <input type="text" class="form-control" name="nomConducteur" required placeholder="Ex: Jean Dupont">
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">Email</label>
                    <input type="email" class="form-control bg-light" name="emailConducteur" id="inputEmail" readonly>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">Mobile</label>
                    <input type="tel" class="form-control" name="mobileConducteur" required placeholder="06 12 34 56 78">
                  </div>
                </div>

                <hr>

                <h6 class="text-primary mb-3">üöó V√©hicule</h6>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">Marque</label>
                    <input type="text" class="form-control" name="marque" required placeholder="Ex: Peugeot">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">Mod√®le</label>
                    <input type="text" class="form-control" name="modele" required placeholder="Ex: 3008">
                  </div>
                </div>
                <div class="row">
                   <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">Immatriculation</label>
                    <input type="text" class="form-control" name="vehicule" required placeholder="AB-123-CD">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">Lieu souhait√©</label>
                    <select class="form-select" name="garage">
                      <option>Garage Nord</option>
                      <option>Garage Sud</option>
                      <option>Si√®ge</option>
                    </select>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label fw-semibold">Description du probl√®me</label>
                  <textarea class="form-control" name="description" rows="3" required placeholder="D√©taillez la demande..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                  <i class="bi bi-send me-2"></i>Envoyer la demande
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div id="vue-garage" class="section-app">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="fw-bold text-primary">Tableau de Bord Atelier</h3>
          <button class="btn btn-outline-secondary btn-sm" onclick="chargerDonneesGarage()">
            <i class="bi bi-arrow-clockwise me-1"></i>Actualiser
          </button>
        </div>
        
        <div class="card shadow-sm">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-4">V√©hicule</th>
                  <th>Conducteur</th>
                  <th>Statut</th>
                  <th>Intervention</th>
                  <th class="text-end pe-4">Actions</th>
                </tr>
              </thead>
              <tbody id="corpsTableau"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <div class="modal fade" id="modalPlanif" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">G√©rer l'intervention</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="hiddenId">
            <div class="mb-3">
              <label class="form-label">Date d'intervention pr√©vue</label>
              <input type="date" class="form-control" id="modalDate">
            </div>
            <div class="mb-3">
               <label class="form-label">Statut</label>
               <select class="form-select" id="modalStatut">
                 <option value="EN_ATTENTE">En Attente</option>
                 <option value="PLANIFIE">Planifi√©</option>
                 <option value="EN_COURS">En Cours</option>
                 <option value="TERMINE">Termin√©</option>
               </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="sauvegarderPlanif()">Valider</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let modalInstance;

      window.onload = function() {
        google.script.run.withSuccessHandler(configurerInterface).verifierDroitsUtilisateur();
      };

      function configurerInterface(profil) {
        document.getElementById('userEmail').textContent = profil.email;
        const inputEmail = document.getElementById('inputEmail');
        if(inputEmail) inputEmail.value = profil.email;
        if (profil.estAdmin) document.getElementById('btnSwitchAdmin').classList.remove('d-none');
      }

      function basculerVue(vue) {
        document.querySelectorAll('.section-app').forEach(el => el.classList.remove('active-section'));
        if (vue === 'conducteur') {
          document.getElementById('vue-conducteur').classList.add('active-section');
          document.getElementById('btnSwitchDriver').classList.add('d-none');
          document.getElementById('btnSwitchAdmin').classList.remove('d-none');
        } else if (vue === 'garage') {
          document.getElementById('vue-garage').classList.add('active-section');
          document.getElementById('btnSwitchAdmin').classList.add('d-none');
          document.getElementById('btnSwitchDriver').classList.remove('d-none');
          chargerDonneesGarage();
        }
      }

      document.getElementById('formReparation').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const txt = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = 'Envoi...';
        
        google.script.run.withSuccessHandler((res) => {
            alert(res.message);
            if(res.succes) { 
                this.reset(); 
                document.getElementById('inputEmail').value = document.getElementById('userEmail').textContent; 
            }
            btn.disabled = false; btn.innerHTML = txt;
        }).enregistrerNouvelleDemande(Object.fromEntries(new FormData(this).entries()));
      });

      function chargerDonneesGarage() {
        const tbody = document.getElementById('corpsTableau');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5">Chargement...</td></tr>';
        google.script.run.withSuccessHandler(afficherTableau).recupererListeReparations();
      }

      function afficherTableau(liste) {
        const tbody = document.getElementById('corpsTableau');
        if(!liste || liste.length === 0) {
           tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">Aucune demande.</td></tr>'; return;
        }
        
        tbody.innerHTML = liste.map(item => {
          let badgeColor = item.statut === 'EN_ATTENTE' ? 'warning' : (item.statut === 'TERMINE' ? 'success' : 'info');
          
          // AFFICHAGE MIS A JOUR AVEC MARQUE ET MODELE
          return `
          <tr>
            <td class="ps-4">
              <strong>${item.marque} ${item.modele}</strong><br>
              <small class="text-muted">${item.vehicule}</small>
            </td>
            <td>
              ${item.conducteur}<br>
              <small class="text-muted"><i class="bi bi-phone"></i> ${item.mobile}</small>
            </td>
            <td><span class="badge bg-${badgeColor}">${item.statut}</span></td>
            <td>${item.dateIntervention}</td>
            <td class="text-end pe-4">
               <div class="btn-group">
                 <button class="btn btn-sm btn-outline-danger" onclick="envoyerPDF('${item.id}')"><i class="bi bi-file-earmark-pdf"></i></button>
                 <button class="btn btn-sm btn-primary" onclick="ouvrirModal('${item.id}', '${item.statut}')">G√©rer</button>
               </div>
            </td>
          </tr>
        `}).join('');
      }

      function envoyerPDF(id) {
        if(!confirm("Envoyer le PDF ?")) return;
        document.body.style.cursor = 'wait';
        google.script.run.withSuccessHandler(res => {
            document.body.style.cursor = 'default'; alert(res.message);
        }).genererEtEnvoyerPDF(id);
      }

      function ouvrirModal(id, statut) {
        document.getElementById('hiddenId').value = id;
        document.getElementById('modalStatut').value = statut;
        document.getElementById('modalDate').value = ""; 
        modalInstance = new bootstrap.Modal(document.getElementById('modalPlanif'));
        modalInstance.show();
      }

      function sauvegarderPlanif() {
        const id = document.getElementById('hiddenId').value;
        const date = document.getElementById('modalDate').value;
        const statut = document.getElementById('modalStatut').value;
        if (statut === 'PLANIFIE' && !date) { alert("Date obligatoire pour planifier."); return; }
        
        google.script.run.withSuccessHandler(res => {
            alert(res.message); modalInstance.hide(); chargerDonneesGarage();
        }).mettreAJourIntervention(id, statut, date);
      }
    </script>
  </body>
</html>
